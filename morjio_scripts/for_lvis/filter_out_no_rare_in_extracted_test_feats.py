import numpy as np
import ipdb 


feat_path = '/home/nieh/morjio/projects/detection/any_shot_detection/mmfewshot/data/coco/any_shot_detection_extracted_feats_and_embedding_classifier/visual_info_transfer/866_337_zsd_split/lvis_all_test_0.6_0.3_feats.npy'
label_path = '/home/nieh/morjio/projects/detection/any_shot_detection/mmfewshot/data/coco/any_shot_detection_extracted_feats_and_embedding_classifier/visual_info_transfer/866_337_zsd_split/lvis_all_test_0.6_0.3_labels.npy'

feats = np.load(feat_path, allow_pickle=True)
labels = np.load(label_path, allow_pickle=True)

# rare类在1023类中的位置，从0开始
rare_labels_and_bg = [12,  13,  16,  19,  20,  29,  30,  37,  38,  39,  41, 48,  50,  51,  62,  68,  70,  77,  81,  84,  92, 104, 105, 112, 116, 118, 122, 125, 129, 130, 135, 139, 141, 143, 146, 150, 154, 158, 160, 163, 166, 171, 178, 181, 195, 201, 208, 209, 213, 214, 221, 222, 230, 232, 233, 235, 236, 237, 239, 243, 244, 246, 249, 250, 256, 257, 261, 264, 265, 268, 269, 274, 280, 281, 286, 290, 291, 293, 294, 299, 300, 301, 303, 306, 309, 312, 315, 316, 320, 322, 325, 330, 332, 347, 348, 351, 352, 353, 354, 356, 361, 363, 364, 365, 367, 373, 375, 380, 381, 387, 388, 396, 397, 399, 404, 406, 409, 412, 413, 415, 419, 425, 426, 427, 430, 431, 434, 438, 445, 448, 455, 457, 466, 477, 478, 479, 480, 481, 485, 487, 490, 491, 502, 505, 507, 508, 512, 515, 517, 526, 531, 534, 537, 540, 541, 542, 544, 550, 556, 559, 560, 566, 567, 570, 571, 573, 574, 576, 579, 581, 582, 584, 593, 596, 598, 601, 602, 605, 609, 615, 617, 618, 619, 624, 631, 633, 634, 637, 639, 645, 647, 650, 656, 661, 662, 663, 664, 670, 671, 673, 677, 685, 687, 689, 690, 692, 701, 709, 711, 713, 721, 726, 728, 729, 732, 742, 751, 753, 754, 757, 758, 763, 768, 771, 777, 778, 782, 783, 784, 786, 787, 791, 795, 802, 804, 807, 808, 809, 811, 814, 819, 821, 822, 823, 828, 830, 848, 849, 850, 851, 852, 854, 855, 857, 858, 861, 863, 868, 872, 882, 885, 886, 889, 890, 891, 893, 901, 904, 907, 912, 913, 916, 917, 919, 924, 930, 936, 937, 938, 940, 941, 943, 944, 951, 955, 957, 968, 971, 973, 974, 982, 984, 986, 989, 990, 991, 993, 997, 1002, 1004, 1009, 1011, 1014, 1015, 1027, 1028, 1029, 1030, 1031, 1046, 1047, 1048, 1052, 1053, 1056, 1057, 1074, 1079, 1083, 1115, 1117, 1118, 1123, 1125, 1128, 1134, 1143, 1144, 1145, 1147, 1149, 1156, 1157, 1158, 1164, 1166, 1192, 1203]

replace_id = 10000
lvis_num_classes = 1203
for label_id in range(lvis_num_classes+1):
    if label_id not in rare_labels_and_bg:
        labels[labels==label_id] = replace_id
feats = feats[labels!=replace_id]
labels = labels[labels!=replace_id]

save_feat_path = '/home/nieh/morjio/projects/detection/any_shot_detection/mmfewshot/data/coco/any_shot_detection_extracted_feats_and_embedding_classifier/visual_info_transfer/866_337_zsd_split/lvis_unseen_test_0.6_0.3_feats.npy'
save_label_path = '/home/nieh/morjio/projects/detection/any_shot_detection/mmfewshot/data/coco/any_shot_detection_extracted_feats_and_embedding_classifier/visual_info_transfer/866_337_zsd_split/lvis_unseen_test_0.6_0.3_labels.npy'

np.save(save_feat_path, feats)
np.save(save_label_path, labels)


testset_rare_label_ids = [12, 19, 20, 29, 50, 62, 68, 70, 92, 105, 116, 122, 125, 129, 130, 135, 141, 146, 154, 158, 160, 163, 166, 171, 195, 208, 213, 221, 222, 235, 237, 239, 250, 265, 281, 290, 293, 294, 306, 309, 315, 316, 322, 325, 330, 347, 348, 351, 356, 361, 363, 364, 365, 367, 380, 388, 397, 399, 404, 406, 409, 412, 415, 426, 427, 431, 434, 448, 455, 478, 479, 481, 485, 487, 505, 508, 512, 515, 531, 534, 537, 540, 542, 550, 556, 559, 560, 571, 579, 598, 601, 602, 609, 617, 618, 619, 624, 631, 633, 634, 637, 647, 650, 656, 662, 670, 677, 685, 687, 690, 692, 721, 732, 751, 753, 754, 757, 758, 763, 782, 783, 784, 786, 787, 795, 802, 804, 809, 811, 819, 821, 828, 830, 851, 858, 872, 885, 886, 890, 891, 907, 912, 913, 916, 919, 936, 937, 938, 940, 941, 943, 951, 973, 982, 984, 990, 991, 993, 1011, 1015, 1027, 1029, 1030, 1046, 1047, 1048, 1052, 1056, 1115, 1117, 1128, 1143, 1144, 1147, 1149, 1158, 1164, 1192]

# map testset_rare_label_ids from 0 to 177
length = len(testset_rare_label_ids)
testset_rare_label_id2idx = {testset_rare_label_ids[i]: i for i in range(length)}

# output is:
# {12: 0, 19: 1, 20: 2, 29: 3, 50: 4, 62: 5, 68: 6, 70: 7, 92: 8, 105: 9, 116: 10, 122: 11, 125: 12, 129: 13, 130: 14, 135: 15, 141: 16, 146: 17, 154: 18, 158: 19, 160: 20, 163: 21, 166: 22, 171: 23, 195: 24, 208: 25, 213: 26, 221: 27, 222: 28, 235: 29, 237: 30, 239: 31, 250: 32, 265: 33, 281: 34, 290: 35, 293: 36, 294: 37, 306: 38, 309: 39, 315: 40, 316: 41, 322: 42, 325: 43, 330: 44, 347: 45, 348: 46, 351: 47, 356: 48, 361: 49, 363: 50, 364: 51, 365: 52, 367: 53, 380: 54, 388: 55, 397: 56, 399: 57, 404: 58, 406: 59, 409: 60, 412: 61, 415: 62, 426: 63, 427: 64, 431: 65, 434: 66, 448: 67, 455: 68, 478: 69, 479: 70, 481: 71, 485: 72, 487: 73, 505: 74, 508: 75, 512: 76, 515: 77, 531: 78, 534: 79, 537: 80, 540: 81, 542: 82, 550: 83, 556: 84, 559: 85, 560: 86, 571: 87, 579: 88, 598: 89, 601: 90, 602: 91, 609: 92, 617: 93, 618: 94, 619: 95, 624: 96, 631: 97, 633: 98, 634: 99, 637: 100, 647: 101, 650: 102, 656: 103, 662: 104, 670: 105, 677: 106, 685: 107, 687: 108, 690: 109, 692: 110, 721: 111, 732: 112, 751: 113, 753: 114, 754: 115, 757: 116, 758: 117, 763: 118, 782: 119, 783: 120, 784: 121, 786: 122, 787: 123, 795: 124, 802: 125, 804: 126, 809: 127, 811: 128, 819: 129, 821: 130, 828: 131, 830: 132, 851: 133, 858: 134, 872: 135, 885: 136, 886: 137, 890: 138, 891: 139, 907: 140, 912: 141, 913: 142, 916: 143, 919: 144, 936: 145, 937: 146, 938: 147, 940: 148, 941: 149, 943: 150, 951: 151, 973: 152, 982: 153, 984: 154, 990: 155, 991: 156, 993: 157, 1011: 158, 1015: 159, 1027: 160, 1029: 161, 1030: 162, 1046: 163, 1047: 164, 1048: 165, 1052: 166, 1056: 167, 1115: 168, 1117: 169, 1128: 170, 1143: 171, 1144: 172, 1147: 173, 1149: 174, 1158: 175, 1164: 176, 1192: 177}

ipdb.set_trace()